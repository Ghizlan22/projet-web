document.addEventListener("DOMContentLoaded", () => {
    const fileInput = document.getElementById("fileInput");
    const choixLangueBtn = document.getElementById("choix-langue");
    const langOptions = document.getElementById("lang-options");
    const translateBtn = document.getElementById("traduction");
    const resultatDiv = document.getElementById("resultat");
    const questionReponseBtn = document.getElementById("question-reponse");
    const qaSection = document.getElementById("qa-section");
    const questionInput = document.getElementById("questionInput");
    const imageInput = document.getElementById("imageInput");
    const envoyerQuestionBtn = document.getElementById("envoyer-question");
    const reponseDiv = document.getElementById("reponse");

    // Correspondance entre affichage et code langue
    const languageMap = {
         "Fran√ßais": "fr",
         "Anglais": "en",
         "Allemand": "de",
         "Espagnol": "es",
         "Italien" : "it",
         "Chinois" : "zh",
         "Arabe"   : "ar"
    };

    let selectedLanguage = "";
    let uploadedFile = null;

    // Gestion de l'upload du fichier
    fileInput.addEventListener("change", (event) => {
        uploadedFile = event.target.files[0];
        if (uploadedFile) {
            resultatDiv.innerHTML = `<p>üìÇ Fichier s√©lectionn√© : <strong>${uploadedFile.name}</strong></p>`;
        }
    });

    // Toggle du menu des langues avec animation
    choixLangueBtn.addEventListener("click", () => {
        langOptions.style.display = langOptions.style.display === "block" ? "none" : "block";
        langOptions.classList.toggle("fade-in");
    });
    /*
    // S√©lection de la langue
    document.querySelectorAll(".lang-btn").forEach(button => {
        button.addEventListener("click", () => {
            selectedLanguage = button.textContent.trim();
            choixLangueBtn.innerHTML = `üåç ${selectedLanguage}`;
            langOptions.style.display = "none";
        });
    });
    */
    // S√©lection de la langue
    document.querySelectorAll(".lang-btn").forEach(button => {
        button.addEventListener("click", () => {
            //const selectedText = button.textContent.trim(); // Ex: "Anglais"
            selectedLanguage = button.getAttribute("data-lang"); // Prend le bon code de langue
            choixLangueBtn.innerHTML = `üåç ${button.textContent.trim()}`;
            langOptions.style.display = "none";
            console.log("Langue s√©lectionn√©e :", selectedLanguage); // üî• Debug dans la console
        });
    });
     
    // Fonction pour envoyer le fichier et r√©cup√©rer la traduction
    async function uploadFileForTranslation() {
        if (!uploadedFile) {
            showMessage("‚ö†Ô∏è Aucun fichier s√©lectionn√©.", "error");
            return;
        }
        if (!selectedLanguage) {
            showMessage("‚ö†Ô∏è Veuillez choisir une langue.", "error");
            return;
        }

        const formData = new FormData();
        formData.append("file", uploadedFile);
        formData.append("language", selectedLanguage); // Changement ici
        // üîç Affiche les donn√©es envoy√©es dans la console
        console.log("Donn√©es envoy√©es :", [...formData.entries()]);

        try {
            showMessage("‚è≥ Traduction en cours...", "loading");
            const response = await fetch("http://127.0.0.1:8000/translate", {
                method: "POST",
                body: formData
            });
            const data = await response.json();
            console.log("R√©ponse de l'API :", data);


            if (data.error) {
                showMessage(`‚ùå Erreur : ${data.error}`, "error");
            } else {
                showMessage(`<h3>üåç Traduction :</h3><p>${data.translation.replace(/\n/g, "<br>")}</p>`, "success");
            }
        } catch (error) {
            showMessage(`‚ùå Erreur : ${error.message}`, "error");
        }
    }

    // Bouton traduction
    translateBtn.addEventListener("click", uploadFileForTranslation);

    // Fonction pour afficher les messages avec style
    function showMessage(message, type) {
        resultatDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
    }
    // üß† Activation de la section Question/R√©ponse
    questionReponseBtn.addEventListener("click", () => {
        qaSection.style.display = qaSection.style.display === "none" ? "block" : "none";
    });

    // üì§ Envoi de la question ou de l'image √† l'IA
    async function envoyerQuestion() {
        const question = questionInput.value.trim();

        if (!question && !uploadedFile) {
            reponseDiv.innerHTML = `<div class="message error">‚ö†Ô∏è Veuillez entrer une question ou s√©lectionner une image.</div>`;
            return;
        }

        const formData = new FormData();
        if (uploadedFile) {
            formData.append("file", uploadedFile);
        }
        if (question) {
            formData.append("question", question);
        }

        try {
            reponseDiv.innerHTML = `<div class="message loading">‚è≥ Analyse en cours...</div>`;
            const response = await fetch("http://127.0.0.1:8000/ask", {
                method: "POST",
                body: formData
            });
            const data = await response.json();

            if (data.error) {
                reponseDiv.innerHTML = `<div class="message error">‚ùå Erreur : ${data.error}</div>`;
            } else {
                reponseDiv.innerHTML = `<h3>üß† R√©ponse :</h3><p>${data.response.replace(/\n/g, "<br>")}</p>`;
            }
        } catch (error) {
            reponseDiv.innerHTML = `<div class="message error">‚ùå Erreur : ${error.message}</div>`;
        }
    }
     
    // Rendre le champ de saisie actif si d√©sactiv√© par erreur
    questionInput.removeAttribute("disabled");
    // Bouton envoyer question
    envoyerQuestionBtn.addEventListener("click", envoyerQuestion);
});

